<!--B"H-->
<!DOCTYPE html>
<html>
  <head>
    <title>Dach | ◊ì◊ê◊¥◊ó</title>
    <meta charset="utf-8">
    <!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-8G4BNTZDFN"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-8G4BNTZDFN');
</script>
    <script src="/scripts/installEved.js"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=yes">
    <link rel="stylesheet" href="/style.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+Hebrew:wght@100..900&display=swap" rel="stylesheet">
    <script>
        function startDrag(e) {
          console.log("HI!")
          if (window.matchMedia('(max-width: 600px)').matches) {
            console.log("size?")
            let mouseY;
            if (e.touches) {
              mouseY = e.touches[0].clientY;
            } else {
              mouseY = e.clientY;
            }

            const bottomSheet =  document.querySelector('.viewer .left-box');
   
            function handleDrag(e) {
              e.preventDefault(); // Prevent pull-to-refresh behavior on mobile

              const newHeight = bottomSheet.clientHeight + mouseY - (e.touches ? e.touches[0].clientY : e.clientY);
              if (newHeight > 60) {
                bottomSheet.style.height = newHeight + 'px';
              }
              mouseY = e.touches ? e.touches[0].clientY : e.clientY;
            }

            function stopDrag() {
              document.removeEventListener('mousemove', handleDrag);
              document.removeEventListener('touchmove', handleDrag);
              document.removeEventListener('mouseup', stopDrag);
              document.removeEventListener('touchend', stopDrag);
            }

            document.addEventListener('mousemove', handleDrag);
            document.addEventListener('touchmove', handleDrag, { passive: false }); // Ensure preventDefault works
            document.addEventListener('mouseup', stopDrag);
            document.addEventListener('touchend', stopDrag);
        }
      }
      function increaseFont() {
        adjustFontSize("#content0", "increase")
        adjustFontSize(".paragraph-container p", "increase")
      }

      function decreaseFont() {
        adjustFontSize("#content0", "decrease")
        adjustFontSize(".paragraph-container p", "decrease")
      }

      function adjustFontSize(sl, action) {
       
        const paragraphs = Array.from(document.querySelectorAll(sl));
        console.log("Trying",sl,paragraphs,action)
        paragraphs.forEach(paragraph => {
          const currentFontSize = window.getComputedStyle(paragraph).fontSize;
          let newSize;

          if (action === 'increase') {
            newSize = parseFloat(currentFontSize) * 1.2 + 'px';
          } else if (action === 'decrease') {
            newSize = parseFloat(currentFontSize) * 0.8 + 'px';
          }

          paragraph.style.fontSize = newSize;
        });
      }


    </script>
  </head>
  <body>
    <div class="viewer page">
        <header class="header">
            <div class="left">
              
          <div class="logo"><a href="/">Dach | ◊ì◊ê◊¥◊ó</a></div>
              <!--<div class="menu-item">Community</div>
              <div class="menu-item">Texts</div>-->
            </div>
            <div class="right">
              
              <div class="hidden menu-btn loginBtn">Log in</div>
            </div>
          </header>
          <div class="flex-container">
            <div class="left-box" id="resizableBox">
                
                <div class="tab-container">
                    <div class="tabs" onmousedown="startDrag(event)" ontouchstart="startDrag(event)" ondragstart="startDrag(event)" >
                      
                        <div class="tab hidden" id="tab0">◊©◊ô◊¢◊ï◊®◊ô◊ù</div>
                        <div class="tab hidden" id="tab1">◊™◊®◊í◊ï◊û◊ô◊ù</div>
                        <div class="tab hidden" id="tab2">◊ß◊ô◊¶◊ï◊®</div>
                        <div class="tab">◊î◊¢◊®◊ï◊™</div>
                        <div class="tab-indicator"></div>
                    </div>
                    <div class="content footnotesCnt" id="content0"></div>
                    <div class="content hidden" id="content1">
                      <div class="editSecrets hidden">

                        <!DOCTYPE html>
                        <html lang="en">
                        <head>
                            <meta charset="UTF-8">
                            <meta name="viewport" content="width=device-width, initial-scale=1.0">
                            <style>
                                /* Basic styling for the form */
                                .form-row {
                                    margin-bottom: 10px;
                                    display: flex;
                                    flex-wrap: wrap;
                                }

                                /* Style the individual items within each row */
                                .form-item {
                                    flex: 1;
                        padding: 15px;
                                    margin-right: 10px;
                                    min-width: 0;
                                }

                                .horizontal-row .form-item:nth-child(3) {
                                    flex: 3;
                                }

                                input[type="submit"] {
                                    width: 100%;
                                }
                            </style>
                            <title>Your Simple Form</title>
                        </head>
                        <body>

                        
                        <form id="LOL" action="/submit-form" method="post">
                           
                            <div class="form-row horizontal-row">
                          
                            </div>

                            <div class="form-row">
                                <textarea name="Kitzur" id="Kitzur" placeholder="Kitzur" rows="4" class="form-item" ></textarea>
                            </div>
                            

                            <div class="form-row">
                                <input type="submit" value="Submit" class="form-item">
                            </div>
                        </form>

                        </body>
                        </html>

                      </div>
                    </div>
                  
                    <div class="content hidden" id="content2">
             
                      <div class="editSecrets hidden">
                        <button id="transB">Translate with AI</button>
                        <button id="transBA">Translate active paragraph</button>
                        <br>
                        <input type="checkbox" id="isOld"><label for="isOld">
                          Use "Older" version?
                        </label>
                      </div>
                      <div class="translationProgress" id="translationProgress"></div>
                    </div>
                    <div class="content hidden" id="content3">Content for Tab 4</div>
                </div>

            </div>
            <div class="right-box">
                <div class="app-bar">
                    <div class="app-barContent">
                        <div id="app-barButtons">
                        <!--<div id="indexButton" class="list toggle-button btn"></div>-->
                        <div class="menu-btn" id="showE">A</div>
                        <div id="settingsButton" class="settingsIcon invisible toggle-button btn"></div>
                       
                      </div>
                      <div class="appbar-title-container">
                        <div class="default-title" id="work_title"></div>
                        <!-- <div class="settings-expanded-title">Settings Title</div>
                        <div class="index-expanded-title">Index Title</div> -->
                    </div>
                    
                      <div id="app-barButtons" data-menu="true">
                        
                        
                        <div id="indexButton" class="list toggle-button btn"></div>
                        <div id="settingsButton" class="settingsIcon toggle-button btn">
                        </div>
                      </div>
                        
                    </div>
                    <div id="expanded">Content for the expanded div</div>
                  </div>
                  <div class="paragraph-content">
                    <div class="paragraph-container">
                      <div class="loader"></div>
                    </div>
                </div>
                
              <div id="errorReportD" class="hidden">
                <h4>Text</h4>
                <button id="mBold">Bold</button>
                
                <button id="mSup">Sup</button>
                <button id="errorReport">Report</button>
                <button id="errorCancel">Cancel</button>
              </div>
              
            </div>
        </div>
    </div>

    <div id="toast" class="hide">
      Toast Notification
    </div>

    <div id="right-click-menu">
      <ul>
        <li id="copy">&#128203; Copy Text</li>
        <li id="print">üñ®Ô∏è Print</li>
        <li id="reportErrorBtn">&#9888; Report Error</li>
      </ul>
    </div>

    <script src="/scripts/login.js" type="module"></script>
    <script src="/viewer/viewerhighlight.js"></script>
    <script src="/viewer/sichaLoading.js" type="module"></script>
    
    <script src="/viewer/settingsMenu.js" type="module"></script>
    <script type="module">
      

      function submitEdit({
        paragraph_num,
        lang,
        edited_text
      }) {
        if(!isEditing) {
        return new Promise((r,j) => {
            //B"H
          // Define the URL of your Cloud Function
          const cloudFunctionURL = 'https://submiteditsuggestion-2q5fj4mnha-uc.a.run.app';


              var [
                type
              ] = location.pathname.split("/").slice(-4);
              var [id] = location.pathname.split("/").slice(-1)
              type = type == "meluket" ? "maamar" : "sicha";

              // Sample data to be sent in the request body
              const requestData = {
                  edited_text,
                  paragraph_num,
                  id,
                  lang,
                  type
              };

              // Options for the fetch request
              const requestOptions = {
                          method: 'POST',
                          headers: {
                              'Content-Type': 'application/json',
                              
                              // Add authentication token if needed
                              'Authorization': user.accessToken
                          },
                    body: JSON.stringify(requestData)
                };

            // Send the fetch request to the Cloud Function
            fetch(cloudFunctionURL, requestOptions)
                .then(response => {
                    
                    return response.json();
                })
                .then(data => {
                    console.log('Edit suggestion submitted successfully:', data);
                    r(data)
                })
                .catch(error => {
                    console.error('Error submitting edit suggestion:', error);
                    j(error)
                });
            })

          } else {
            console.log("Trying to submit edit!!")
            var d = window.currentData;
            if(!d) {
              return showToast("For some reason, database data isn't loaded, so its' not working")
            }

            var m = Array.from(d.Maamar);
            if(!m) {
              return showToast("Not on a maamar")
            }

            var part = m[paragraph_num];
            if(!part) {
              return showToast("Paragraph not found")
            }

            var type = part[lang];
            if(!type) {
              return showToast("That language: "+lang+" not working now.")
            }

            part[lang] = edited_text


            var ref = getDocRef();
              
            updateDoc(ref, {
              Maamar: m
            }).then(didIt => {
              console.log("updated!",didIt)
              showToast("Edited the paragraph number "+paragraph_num+ " successfully")
              r(didIt)
            }).catch(e => {
              console.log(e);
              j(e)
              return showToast("Couldn't update.")
            });
          }
       
      }

      mBold.onclick = toggleBold;
      mSup.onclick = toggleSuperscript;

      addEventListener("keypress", e => {
        // Check if Ctrl key is pressed along with B or M key
        if (e.ctrlKey && (e.key === 'b' || e.key === 'B')) {
            // Prevent the default browser behavior
            e.preventDefault();
            // Toggle bold
            toggleBold();
        } else if (e.ctrlKey && (e.key === 'm' || e.key === 'M')) {
            // Prevent the default browser behavior
            e.preventDefault();
            // Toggle superscript
            toggleSuperscript();
        }
    });
      function toggleSuperscript() {
        // Get the selected text
        let selection = window.getSelection();
        let selectedText = selection.toString();

        // Check if there is a selected text
        if (selectedText) {
            // Create a range based on the selection
            let range = selection.getRangeAt(0);

            // Check if the selected text is already in superscript
            let isSuperscript = range.commonAncestorContainer.parentNode.nodeName === 'SUP';

            // If the text is already in superscript, remove the <sup> tags
            if (isSuperscript) {
                // Get the parent element (which should be <sup>)
                let superscriptElement = range.commonAncestorContainer.parentNode;

                // Replace the <sup> element with its children (i.e., the text nodes)
                while (superscriptElement.firstChild) {
                    superscriptElement.parentNode.insertBefore(superscriptElement.firstChild, superscriptElement);
                }
                superscriptElement.parentNode.removeChild(superscriptElement);
            } else {
                // If the text is not in superscript, wrap it with <sup> tags
                let superscriptElement = document.createElement('sup');
                superscriptElement.textContent = selectedText;
                range.deleteContents();
                range.insertNode(superscriptElement);
            }
        }
    }
      function toggleBold() {
        // Get the selected text
        let selection = window.getSelection();
        let selectedText = selection.toString();

        // Check if there is a selected text
        if (selectedText) {
            // Create a range based on the selection
            let range = selection.getRangeAt(0);

            // Check if the selected text is already bold
            let isBold = range.commonAncestorContainer.parentNode.nodeName === 'B';

            // If the text is already bold, remove the <b> tags
            if (isBold) {
                // Get the parent element (which should be <b>)
                let boldElement = range.commonAncestorContainer.parentNode;

                // Replace the <b> element with its children (i.e., the text nodes)
                while (boldElement.firstChild) {
                    boldElement.parentNode.insertBefore(boldElement.firstChild, boldElement);
                }
                boldElement.parentNode.removeChild(boldElement);
            } else {
                // If the text is not bold, wrap it with <b> tags
                let boldElement = document.createElement('b');
                boldElement.textContent = selectedText;
                range.deleteContents();
                range.insertNode(boldElement);
            }
        }
    }

      async function continueIfLoggedIn() {
        var loggedIn = await checkIfLoggedin();
        console.log(loggedIn, "testing")
        var usr;
        if(!loggedIn.user || !loggedIn.user.auth.currentUser) {
          console.log("sing in google")
          usr = await signInGoogle();
          console.log("Checking",usr)
          console.log(usr)
          if(!usr || !usr.auth.currentUser) {
            return await continueIfLoggedIn();
          }
        }
        

        return true;
      }
      var curParIdx = null;
      var initialHTML = null;
      
      var errorClicked = false;
      reportErrorBtn.onclick = async () => {
        var signed = await continueIfLoggedIn()
        console.log("signed in",signed)
        if(signed) {
          
          if(curParIdx) {
            errorReportD.classList.remove("hidden");
            console.log("Editing",curParIdx)
            var el  =curParIdx.el;
            if(el) {
              initialHTML = el.innerHTML;
              makeElementEditable(el)
            }
          }

        }
      };

      errorReport.onclick = async () => {
        if(curParIdx) {
          var el  =curParIdx.el;
            if(el) {
              
              if(initialHTML) {
                var oldR = errorReport.textContent;
                errorReport.textContent = "Submitting.."
                
                showToast("Submitting");
                try {
                  
                  var html = saveEditableElement(el)

                  await submitEdit({
                    paragraph_num:curParIdx.idx,
                    lang: curParIdx.lang,
                    edited_text: html
                  });
                  

                  //errorReport.textContent = "Submitted! Refreshing.."
                  errorReport.textContent = "Edited. Refreshing.."
                  await getIt()
                  
                  showToast("Successfully reported edits!");
                  
                  initialHTML = null;
                  errorReportD.classList.add("hidden")

                  errorReport.textContent = "Edit"
                  curParIdx = null;
                  errorClicked = false;
                  return
                } catch(e) {
                  console.log("Sbmit error",e)
                  showToast("Problem submitting");
                }
                el.innerHTML = initialHTML;
                
                initialHTML = null;
              }
            }
        }
      }


      errorCancel.onclick = () => {
        if(curParIdx) {
          var el  =curParIdx.el;
            if(el) {
              saveEditableElement(el)
              if(initialHTML) {
                el.innerHTML = initialHTML;
                initialHTML = null;
              }
              errorReportD.classList.add("hidden");
              curParIdx = null;
              errorClicked = false;
            }
        }
      }


      function saveEditableElement(el) {
        var html = el.innerHTML;
        el.contentEditable = false;
       // el.innerHTML = html;
        return html;
      }

      function makeElementEditable(el) {
        var html = el.innerHTML;
        el.contentEditable = true;
      //  el.textContent = html;
        return html;
      }

      document.addEventListener('contextmenu', function (e) {
        e.preventDefault();
        
        var rightClickMenu = document.getElementById('right-click-menu');
        var idx = findParentWithDatasetProperty(e.target, "pIndex")
        //e.target.dataset.pIndex;
        //console.log("Index!",idx,e.target,e.target.dataset)


        if(idx) {
          var lang = e.target.classList.contains("heb") ? "heb" : "eng"
          console.log(e.target,lang)
          curParIdx = {
            idx: idx.value,
            el: e.target,
            lang
          };
          errorClicked = true;
          rightClickMenu.style.display = 'block';
          rightClickMenu.style.left = e.pageX + 'px';
          rightClickMenu.style.top = e.pageY + 'px';
          return;
        }
        rightClickMenu.style.display = "none"
        
      });

      document.addEventListener('click', function (e) {
        var rightClickMenu = document.getElementById('right-click-menu');
        rightClickMenu.style.display = 'none';
        if(!errorClicked)
          curParIdx  = null;
      });

      if(isEditing) {
        reportErrorBtn.textContent = "Edit"
        errorReport.textContent = "Edit"
        var lg = document.querySelector(".loginBtn")
        if(lg) {
          lg.classList.remove("hidden")
        }
        content1.classList.remove("hidden")
        content2.classList.remove("hidden");

        tab0.classList.remove("hidden")
        tab1.classList.remove("hidden")

        tab2.classList.remove("hidden")
      }

      function findParentWithDatasetProperty(element, propertyName) {
        let parent = element.parentElement;

        while (parent) {
            if (parent.dataset.hasOwnProperty(propertyName)) {
                return { element: parent, value: parent.dataset[propertyName] };
            }
            parent = parent.parentElement;
        }

        return null;
    }


    var pc/*paragprah container*/ = null;

    function hashChange() {
      console.log('Hash changed', location.hash);
     
    }


    addEventListener('hashchange', hashChange);

    console.log("laoding",window.getEventListeners)

    function removeAllEventListeners(element, eventType) {
      console.log("Removing",eventType,"from",element,window.getEventListeners)
       // const listeners = window.getEventListeners(element)[eventType];
       var listeners = [] 
       if (listeners) {
            listeners.forEach(listener => {
                element.removeEventListener(eventType, listener.listener);
            });
        }
    }

    window.changeHashElement = (key, value) => {
     // console.log("Removing!!")
     // window.removeEventListener("hashchange", hashChange)
     // removeAllEventListeners(window, "hashchange")
      var curHash = new URLSearchParams(location.hash.substring(1))
      if(value) 
        curHash.set(key, value)
      else {
        try {
          curHash.delete(key)
        } catch(e) {}
      }
      console.log("Setting")
      location.hash = "#" + curHash;
      //addEventListener("hashchange", hashChange)
    }
    addEventListener("awtsmoosWroteAll", e=> {
      console.log("Awtsmoos wrote!")
      /**
       * for example, read hash for paragraph number and other things
       * 
       * */
      location.hash = location.hash;
      var hash = getHashVars();
      console.log("Awtsmoos hash!", hash)
      var pr = hash.get("par");
      if(pr) {
        var par = getParagraphById(pr)
        if(par) {
          console.log("scrolling",par,pr)
          par.scrollIntoView()
        }
      }

      var eng = hash.get("eng");
      if(eng) {
        showE.click();
      }
    })


    function getParagraphById(id) {
      if(!pc) {
        pc = document.querySelector(".paragraph-container");
        if(!pc) return console.log("No container")
      }
      
      try {
        return Array.from(pc.children)
          .find(w=>w.dataset.pIndex == id)
      } catch(e) {return null}
    }
    function getHashVars() {
      var h = new URLSearchParams(location.hash.substring(1))
      return h;
    }

      // Add an event listener for the custom event on the window object
      window.addEventListener("awtsmoosAuth", function(e) {
        
        var ed = Array.from(document.querySelectorAll(".editSecrets"))
        //console.log("auth changed!", e.detail,ed); // Access the passed data through e.detail
        var isa = e.detail.isAllowed;
        if(isa) {
          showToast("You are authorized and logged in")
          console.log("I Am allowed. yay",ed)
          ed.forEach(w=>w.classList.remove("hidden"));
          setupClickEvents()
        } else {
          
          console.log("I Am NOT AT ALL allowed. no",ed)
          ed.forEach(w=>w.classList.remove("add"))
        }
      });

      function setEvent(w, prop) {
        var editingPar = false;
          w.contentEditable = true;
          var parIdx = null
          w.onfocus = () => {

            if(!editingPar) {
              editingPar = true;
              /*var sup = Array.from(w.querySelectorAll("sup"))
              sup.forEach(w=>{
                var txt = document.createTextNode(w.textContent);
                w.replaceWith(txt)
              });*/

              if(prop == "heb")
                w.textContent = w.innerHTML;
              var parent = w.parentNode;
              parIdx = parent.dataset.pIndex;
              if(parIdx === undefined) {
                parIdx = w.dataset.hIndex;
              }

              showToast(
                "Started editing the paragraph ID: "
              
                + parIdx
              
              )
              console.log(
                "Started editing english paragraph:",w,
                "paragraph:",parIdx
              )
              w.classList.add("editing")
            }
          };

          w.onblur =async () => {
            if(editingPar) {
              if(parIdx === null) {
                return console.log("Issue with it")
              }
              var ref = getDocRef();
              
              var doc = await getDoc(ref);
              var Ma = doc.get("Maamar");
              
              console.log("Tryin to update",parIdx,ref,doc,Ma)
              var par = Ma[parIdx];
              if(!par) {
                showToast("No paragraph found")
                return console.log("No paragraph found")
              }

              
              Ma[parIdx][prop] = w.textContent;
              try {
                await updateDoc(ref, {
                  Maamar: Ma
                });

                
                if(prop == "heb")
                  w.innerHTML = w.textContent;
                console.log(
                  "Updated paragraph",parIdx,"with",par,prop,
                  "and data",
                  Ma,par
                
                )

                showToast("Successfully edited")
              } catch(e) {
                console.log("Erorr",e)
                showToast("NOT sucessfuly, check console")
              }
             // w.contenteditable = false;
              editingPar = false;
              console.log("Stopped editing english par:",w)


            }
          }
      }

      document.querySelectorAll(".paragraph-container, .paragraph-content")
      .forEach(parent => {
        // Add blur event listener to the parent
        parent.addEventListener('click', function(event) {  
        /*  if (event.target !== child) {
            // Trigger blur event if the click is not on the child element
            child.blur();
          }*/
        });
      })
      
      function setupClickEvents() {
        Array.from(document.querySelectorAll(".english-p"))
        .forEach(w=> {
          setEvent(w,"eng")
        });

        
        Array.from(document.querySelectorAll(".heb"))
        .forEach(w=> {
          setEvent(w,"heb")
        })

        Array.from(document.querySelectorAll(".paragraph-container h2"))
        .forEach(w=> {
          setEvent(w,"heb")
        })
        
        //paragraph-container maamer
      }
      import firebaseConfig from "/config.js"
      // Import the functions you need from the SDKs you need
      import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
      import {
        getFirestore,
        getDoc,
        getDocs,
        doc,
        collection,
        updateDoc
    } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";
          
    
      initializeApp(firebaseConfig);


      var English = null;
      var isEnglish  = false;
      var oldT = null




      async function getRealtimeEnglish(addIt) {
        var enP = Array.from(document.querySelectorAll(".english-p"))
        enP.forEach(w => {
          w.classList.remove("hidden")
        })
 
      }

      window.formatNumbers = numberizeAwtsmoos;
      function numberizeAwtsmoos(str) {
        var nm = str.match(/\D+|\d+/g)
        var result = []
        nm.forEach((a, i, ar) => {
            if(/\d+/.test(a)) {
                /**
                    is number.


                    NOW: All numbers that have WHITESPACE
                    after them AND NON whitespace before them,
                    should be sup-ed
                **/
                if(i == 0) {
                    result.push(a)
                    return;
                }
                var before = ar[i-1]
                if(before[before.length-1] == " ") {
                    result.push(a)
                    return;
                }

                if(i == ar.length - 1) {
                    result.push(`<sup>${a}</sup>`)
                    return;
                }

                
                var after = ar[i+1]
                if(after[0] == " ") {
                    result.push(`<sup>${a}</sup>`)
                    return;
                }
                
            }
            result.push(a)
            
        })
        return result.join("")
    }

      
      const punctuation = ' \t\n\r\v\f.,\'";?!()[]{}:';
      function surroundNumbersWithSup(text) {
        
        const words = [];
        let currentWord = '';
        
        for (let i = 0; i < text.length; i++) {
            const char = text[i];
            const isPunctuation = punctuation.includes(char);
            
            if (isPunctuation) {
                // If it's a punctuation character, process the current word
                if (currentWord !== '') {
                    words.push(processWord(currentWord));
                    currentWord = '';
                }
                // Append the punctuation character as a separate word
                words.push(char);
            } else {
                // Otherwise, add the character to the current word
                currentWord += char;
            }
        }
        
        // Process the last word if it exists
        if (currentWord !== '') {
            words.push(processWord(currentWord));
        }
        
        return words.join('');
    }

    function processWord(word) {
        let cleanedWord = '';
        let numStart = -1;
        let numEnd = -1;
        
        for (let i = 0; i < word.length; i++) {
            const char = word[i];
            
            if (!isNaN(char) && (i === 0 || punctuation.includes(word[i - 1]))) {
                if (numStart === -1) {
                    numStart = i;
                }
                numEnd = i;
            } else {
                if (numStart !== -1) {
                    // Found a number, surround it with <sup> tags
                    cleanedWord += `<sup>${word.slice(numStart, numEnd + 1)}</sup>`;
                    numStart = -1;
                    numEnd = -1;
                }
                cleanedWord += char;
            }
        }
        
        // If there's a number at the end of the word
        if (numStart !== -1) {
            cleanedWord += `<sup>${word.slice(numStart, numEnd + 1)}</sup>`;
        }
        
        return cleanedWord;
    }
      

      /*
        
// Example usage
const exampleText = "This is text5 and (1920) should not change but word88 and word99* should become footnotes, as should end-of-sentence99. or mid:sentence77: but not (123) or a number like 4).";
const formattedText = formatNumbers(exampleText);

console.log(formattedText);
      */
      var pc = document.querySelector(".paragraph-container");
      showE.onclick = showEnglish;
  
      async function showEnglish() {
        console.log("Setting english")
        if(!isEnglish) {
          if(pc) {
            pc.classList.add("english-active")
          }

          console.log("Not currently english")

          oldT = showE.textContent;
          showE.textContent = "◊ê"
          isEnglish = true;
          if(!English) {
            console.log("Getting english")
            await getRealtimeEnglish();
          } else {
            

            setEnglishToParagraphs(English)
            console.log("setting english",English)
          }
          changeHashElement("eng", "emes")
        } else {
          if(pc) {
            pc.classList.remove("english-active")
          }

          var engs =Array.from(document.querySelectorAll(".english-p"))
            engs.forEach(w=>w.classList.add("hidden"));
          isEnglish = false;
          showE.textContent = oldT
          changeHashElement("eng", null)
        }
      }


      
      async function translateParagraph(p, i, ar, docRef=null) {
        
        if(!docRef) docRef = getDocRef();

        var tag = document.createElement("p")
        tag.innerHTML = p.heb;
        var txt = tag.textContent;

        
        var tran = await translateText(txt);
        console.log("translated! ",tran);
        translationProgress.textContent = "Translated it! With: "+ tran;
        
        ar[i].eng = tran;
        await updateDoc(docRef, {
          Maamar: ar
        });

        translationProgress.textContent = "Wrote to firestore!";
        console.log("Wrote to firestore: ", ar, i);
        await getRealtimeEnglish()
      }


      async function getAllDocumentIds(collectionPath) {
        const collectionRef = collection(db, collectionPath);
        const querySnapshot = await getDocs(collectionRef);
        const documentIds = querySnapshot.docs.map(doc => doc.id);
        return documentIds;
      }

      window.getAllDocumentIds = getAllDocumentIds;
      window.translateEntireVolume = translateEntireVolume;
      async function translateEntireVolume(volumeNumber) {

        var docs = await getAllDocumentIds("books/Meluket/Maamarim")
        var withNum = docs.filter(w=>w.includes(volumeNumber));
        console.log("Doing vol:",volumeNumber+"_",withNum, docs)
        for(var i = 0; i < withNum.length; i++) {
          
          var docID = withNum[i];
          try {
            var docRef = getDocRef(docID);
            var doc = await getDoc(docRef);
            var m = doc.get("Maamar");

            console.log(
              "Got the document reference:",
              docRef,
              "And the document:",
              doc,
              "And the Maamar array:",
              m,
              "for doc with ID:",
              docID
            )
            for(var y = 0; y < m.length; y++) {
              
              console.log(
                "Translating paragraph ",
                y,
                "from doc",
                docID,
                "with maamarim",
                m,
                "current paragprah:",
                m[y]
              
              );

              try {

              
                var cur = m[y];
                await translateParagraph(cur, y, m, docRef);
              } catch(e) {
                console.log("Issue with",y,e)
              }
              console.log(
                "Translated succesffuly the paragraph:",
                y
              );


            }
            console.log("Successfully did entire doc with ID:",docID)
          } catch(e) {
            console.log("Error for this doc:", docID,e)
          }
        }
      }
      if(window.transBA)
      transBA.onclick  = async () => {
        if(!isAllowed) 
          return alert("not authoriezd");

        var ref = getDocRef();
        var doc = await getDoc(ref);
        var maamar = doc.get("Maamar");
        var curPar = document.querySelector(".p-div.active")
        var idx = parseInt(curPar.dataset.pIndex)
        translationProgress.textContent = "Translating paragraph with idx "
        + idx;
        console.log("Translating paragrap:",idx,
          "from ",
          maamar
        )
        var el = maamar[idx];
        if(!el) {
          return console.log("Paragpah not found")
        }
        await translateParagraph(el, idx, maamar)
      };
      
      if(window.transB)
      transB.onclick = async () => {
        if(!isAllowed) {
          return alert("You're not allowed!")
        }

        
        var total = null;
        

        

        await traverseMaamar(async (p, i, ar) => {
          
          total = ar.length;
          var percent = i/total;
          var percentText = Math.floor(percent * 100);

          
          console.log("Translatin..",i,total, i / total, p, ar);
          translationProgress.textContent="Translating paragraph #"+(i+1)+ 
          " out of "
          + total + 
          " AKA " + (percentText) + "% complete."

          

          

          await translateParagraph(p, i, ar);
          
        });
      };

      async function traverseMaamar(callback) {
        var dr = getDocRef();
        var snap = await getDoc(dr);
        var m = Array.from(snap.get("Maamar"));
        
        for(var i = 0; i < m.length; i++) {
          await callback(m[i], i, m)
        }
      }

      async function translateText(txt) {
        //B"H
        try {
          var resp = await fetch("https://translatify-2q5fj4mnha-uc.a.run.app/", {
              method: "POST",
              headers: {
                  "content-type":"application/json"
              },
              body: JSON.stringify({
                  toichen: `
                    ${txt}
                  `,
                  old: isOld.checked
              })
                  
          })

          var json =  await resp.json()
          try {
            var txt = json
              .translated
              .candidates[0]
              .content
              .parts[0]
              .text;

            return txt;
          } catch(e) {
            console.log("NOPE!?", json, e)
            return null;
          }
          return txt;
        } catch(e) {
          console.log("DIDNT translate: ",txt)
          return null
        }
      }

      function getDocID() {
        return decodeURIComponent((b=>b[b.length-1])(location.pathname.split("/")))
      }

      function getDocRef(pthId = null) {
        if(!pthId) pthId = getDocID();
        return  doc(db, 'books/Meluket/Maamarim/'+pthId);
      }

      function setEnglishToParagraphs(eng) {
        var enP = Array.from(document.querySelectorAll(".english-p"))
        enP.forEach(w => {
          enP.classList.remove("hidden")
        })

        /*
        var divs = Array.from(document.querySelectorAll(".p-div"))
          .filter(w=>w.children[0].tagName == "P");
        var en = parseDoc(eng).filter(w=>w.textContent);
        var englishDivs = Array.from(document.querySelectorAll(".english-p"));
        englishDivs.forEach(w => {
          w.parentNode.removeChild(w);
        });
        divs.forEach((d,i) => {
          var eeng = en[i];
          if(!eeng) return console.log("Not found!",i,d)
          eeng.classList.add("english-p");
          setSupsForP(eeng);
          d.appendChild(eeng)
        })*/
      }

      function setSupsForP(p) {

        var sups = Array.from(p.getElementsByTagName("sup"));
        var min = null;
        var max = null;

        sups.forEach((s, i, ar) => {
          var nm = s.textContent;
     
          s.onclick = e => {
            var nt = document.querySelector("#content0");
            if(!nt) return console.log("Nothing");
            var ch = activeNotes[nm]//nt.children[nm - 1];
            console.log("OT?",ch)
            if(ch) {
              Array.from(nt.children)
              .forEach(w => {
                w.classList.remove("highlighted")
              });

              ch.classList.add("highlighted");
              ch.scrollIntoView()
              setTimeout(() => {
                ch.classList.remove("highlighted")
              }, 3 * 1000 /*unhighlight after 3 seconds*/)
            } else {
              console.log("NO!",s,activeNotes,nm)
            }
          };
        })
      }

      window.setSupsForP = setSupsForP;
      var db = getFirestore();
      
      

      let darkModeEnabled = false;

      document.addEventListener('DOMContentLoaded', function() {
        const darkModeButton = document.getElementById('darkModeButton');
        if (darkModeButton) {
          darkModeButton.addEventListener('click', toggleDarkMode);
        }
        if(localStorage.darkModeEnabled) {
          setTimeout(() => {
            
          ///  toggleDarkMode();
          }, 500)
        }
      });



      function toggleDarkMode() {
        darkModeEnabled = true
        toggleMode()
        localStorage.darkModeEnabled = true;
      }
      function toggleWhiteMode() {
        darkModeEnabled=false;
        toggleMode()
        localStorage.darkModeEnabled = false;
      }
      function toggleMode() {
        console.log('Button clicked!'); // Check if this log is printed
        

        const elements = document.querySelectorAll('.viewer .right-box, .viewer .left-box, .viewer .right-box .paragraph-container, .paragraph-content p, .viewer .right-box .app-bar, .viewer .left-box .tabs, .viewer .left-box .content, .appbar-title-container');
        elements.forEach(element => {
          element.classList.toggle('dark-mode', darkModeEnabled);
        });
      }
      window.toggleWhiteMode=toggleWhiteMode

      window.toggleDarkMode=toggleDarkMode;



      var timeout = null;
      function showToast(txt) {
        var toast = document.getElementById('toast');
        toast.textContent = txt;
        toast.classList.remove('hide');
        if(timeout === null) {
          timeout = setTimeout(function() {
            toast.classList.add('hide');
          }, 3000); // Hide toast after 3 seconds
        } else {
          clearTimeout(timeout);
          timeout = setTimeout(function() {
            toast.classList.add('hide');
          }, 3000); // Hide toast after 3 seconds
        }
      }

      window.showToast = showToast;



      copy.onclick = async () => {
        var cur = curParIdx;
        if(!cur) {
          return showToast("Didn't copy");
        }
        try {

          var el= cur.el;
          var html = el.innerHTML;
          await copyHTMLToClipboard(html);
          showToast("Copied paragraph!")
        } catch (e) {
          console.log("Issue copying: ",e)
          showToast("Didn't copy")
        }
        
        //htmlContent
      }
      async function copyHTMLToClipboard(htmlContent) {
        // Use the Clipboard API to copy the HTML content to the clipboard
        // Encode the HTML content
        var encodedHTML = new Blob([htmlContent], { type: 'text/html' });
        var plain = htmlToText(htmlContent)
        // Create a ClipboardItem object
        console.log("plain", plain)
        var item = new ClipboardItem({
          'text/html': encodedHTML,
          "text/plain": new Blob([plain], { type: 'text/plain' })
        });
        console.log("Item",item)
        // Copy the ClipboardItem to the clipboard
        return navigator.clipboard.write([item])
          
      }


      function htmlToText(html) {
        var div = document.createElement("div")
        div.innerHTML = html;
        return div.textContent
      }


      /**
       * print stuff
       * 
       * */
      document.getElementById("print").onclick = printPage;
       function printPage() {
        var fontSizeFootnotes = getComputedStyle(content0).fontSize;
        var fontSizeMain = getComputedStyle(document.querySelector(".paragraph-container"))
          printHtml(/*html*/`
              <!--B"H-->
              <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=yes">
              <link rel="stylesheet" href="/style.css">
              <link rel="preconnect" href="https://fonts.googleapis.com">
              <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
              <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+Hebrew:wght@100..900&display=swap" rel="stylesheet">
              
              <div class="viewer print page">
                <div class="flex-container">
                  <div class="right-box">
                    <div class="paragraph-content">
                      <div class="paragraph-container maamar" style="font-size: ${
                        fontSizeMain
                      }">
                        ${
                          document.querySelector(".paragraph-container").innerHTML
                        }
                      </div>
                      
                    </div>
                    <div class="footnotes">
                      <div class="footnotes-container" style="font-size: ${
                        fontSizeFootnotes
                      }">
                      ${window.currentData.Footnotes}
                      </div>
                    </div>
                  </div>
                 
                </div>
              </div>
          `)
       }

       function printHtml(html) {
        
          var iframe = document.createElement('iframe');
        //  document.body.appendChild(iframe);
         //var doc = iframe.contentWindow.document;
          var printWindow = window.open('', '_blank');
          printWindow.document.open();
          var doc = printWindow.document;
          doc.write('<html><head><title>Print</title></head><body>' + html + '</body></html>');
          console.log("Hi!",html,doc)
          
          setTimeout(() => printWindow.print(), 500);
          //document.body.removeChild(iframe);
      }
    </script>
    
  </script>
  </body>
  </html>